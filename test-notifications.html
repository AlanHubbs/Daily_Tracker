<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications Branch Test Suite</title>
    <style>
        body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { color: #333; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .pending { background: #fff3cd; color: #856404; }
        #results { margin-top: 20px; }
        .summary { font-size: 1.2em; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Notifications Branch Test Suite</h1>
    <div id="results"></div>
    <iframe id="testFrame" src="index.html" style="display:none;"></iframe>

    <script>
        const tests = [];
        const results = document.getElementById('results');
        
        function addTest(name, testFn) {
            tests.push({ name, testFn });
        }
        
        function reportTest(name, passed, message = '') {
            const div = document.createElement('div');
            div.className = `test ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `<strong>${passed ? '✓' : '✗'} ${name}</strong>${message ? ': ' + message : ''}`;
            results.appendChild(div);
            return passed;
        }
        
        window.addEventListener('load', async () => {
            const iframe = document.getElementById('testFrame');
            await new Promise(resolve => {
                iframe.onload = resolve;
            });
            
            const iframeWindow = iframe.contentWindow;
            const iframeDoc = iframe.contentDocument;
            
            // Test 1: Check if NotificationScheduler exists
            addTest('NotificationScheduler module exists', () => {
                return typeof iframeWindow.NotificationScheduler !== 'undefined';
            });
            
            // Test 2: Check if notification settings exist in AppState
            addTest('Notification settings in AppState', () => {
                const appState = iframeWindow.AppState;
                return appState && 
                       appState.settings && 
                       appState.settings.notifications !== undefined;
            });
            
            // Test 3: Check notification UI elements exist
            addTest('Notification UI elements exist', () => {
                const notifCheckbox = iframeDoc.getElementById('notificationsEnabled');
                const requestBtn = iframeDoc.getElementById('requestNotificationPermissionBtn');
                return notifCheckbox !== null && requestBtn !== null;
            });
            
            // Test 4: Check if settings modal has notification section
            addTest('Settings modal has notification section', () => {
                const settingsModal = iframeDoc.getElementById('settingsModal');
                if (!settingsModal) return false;
                const notifSection = settingsModal.querySelector('h3');
                return notifSection && notifSection.textContent === 'Notifications';
            });
            
            // Test 5: Check notification scheduler init function
            addTest('NotificationScheduler.init function exists', () => {
                return typeof iframeWindow.NotificationScheduler.init === 'function';
            });
            
            // Test 6: Check if notification times are configured
            addTest('Notification schedule times configured', () => {
                // Check if default notification times exist in settings
                const appState = iframeWindow.AppState;
                if (!appState || !appState.settings || !appState.settings.notifications) return false;
                
                // The notifications feature should have schedule times
                return appState.settings.notifications.hasOwnProperty('enabled');
            });
            
            // Test 7: Verify no console errors
            addTest('No console errors on load', () => {
                // This is a simple check - in real testing we'd capture console
                return true; // Placeholder - would need console interception
            });
            
            // Test 8: Check localStorage compatibility
            addTest('Settings saved to localStorage', () => {
                const stored = localStorage.getItem('daily_tracker_settings');
                if (!stored) return false;
                const settings = JSON.parse(stored);
                return settings && settings.notifications !== undefined;
            });
            
            // Run tests
            let passed = 0;
            let failed = 0;
            
            for (const test of tests) {
                try {
                    const result = test.testFn();
                    if (reportTest(test.name, result)) {
                        passed++;
                    } else {
                        failed++;
                    }
                } catch (e) {
                    reportTest(test.name, false, `Error: ${e.message}`);
                    failed++;
                }
            }
            
            // Summary
            const summary = document.createElement('div');
            summary.className = 'summary';
            summary.innerHTML = `Test Results: ${passed} passed, ${failed} failed out of ${tests.length} total`;
            summary.style.color = failed === 0 ? 'green' : 'red';
            results.appendChild(summary);
        });
    </script>
</body>
</html>